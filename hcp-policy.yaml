apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  annotations:
    policy.open-cluster-management.io/categories: CM Configuration Management
    policy.open-cluster-management.io/controls: CM-2 Baseline Configuration
    policy.open-cluster-management.io/standards: NIST SP 800-53
  name: metrics-forwarder
  namespace: openshift-acm-policies
spec:
  disabled: false
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
            name: metrics-forwarder
        spec:
            remediationAction: enforce
            evaluationInterval:
                compliant: 2h
                noncompliant: 45s
            namespaceSelector:
              include: ['ocm-staging-21smh37kqriosut45c6c5taugv7ovvq5-taf-dpmet2']
            object-templates:
              - complianceType: musthave
                objectDefinition:
                  apiVersion: package-operator.run/v1alpha1
                  kind: Package
                  metadata:
                    name: metrics-forwarder
                  spec:
                    image: quay.io/taislam_osd/dataplane-metrics-proxy:latest
---
apiVersion: apps.open-cluster-management.io/v1
kind: PlacementRule
metadata:
  name: metrics-forwarder-rule
  namespace: openshift-acm-policies
spec:
  clusterConditions:
  - status: "True"
    type: ManagedClusterConditionAvailable
  clusterSelector:
    matchExpressions:
    - key: name
      operator: In
      values:
        - 'hs-mc-jsui4ri9g'
---
apiVersion: policy.open-cluster-management.io/v1
kind: PlacementBinding
metadata:
  name: metrics-forwarder-placementbinding
  namespace: openshift-acm-policies
placementRef:
  apiGroup: apps.open-cluster-management.io
  kind: PlacementRule
  name: metrics-forwarder-rule
subjects:
- apiGroup: policy.open-cluster-management.io
  kind: Policy
  name: metrics-forwarder
